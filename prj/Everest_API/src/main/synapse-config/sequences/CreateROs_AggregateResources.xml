<?xml version="1.0" encoding="UTF-8"?>
<sequence name="CreateROs_AggregateResources" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property name="mylog" value="***************************** ITERATING OVER INTERNAL RESOURCES **************************"/>
    </log>
    <!--
	                    		do the next set of invocations to the back-end:
	                    			3. Optional aggregation of internal resources
                                For all fields children of the "internal" field in the body of the client request, invoke the aggregation operation of the back-end.
                                Given the example client request, internal resources to be aggregated are 2, because 2 are the fields children of the "internal" field : {"myfolder/file1.txt": "MTIz"}, {"myfolder/file2.txt": "NDU2"}
                                For the first invocation of the aggregation operation, the http request to be synthesized is (for the other invocation it is analogous, only the Slug header and the body will be different):
                                	
                                	POST /rodl/ROs/cde-20/ HTTP/1.1
									Authorization: Bearer 7d6df5f8-6b5c-4d88-95e1-da101dcee6f8
									Slug: myfolder/file1.txt
									Content-Type: application/octet-stream
									Content-Length: 3
									Host: sandbox.rohub.org
									Connection: Keep-Alive
									User-Agent: Synapse-PT-HttpComponents-NIO
									
									123
									
								Please note that the value of the Slug header is given by the name of the "internal" child field corresponding to each step of the iteration
								Additionally, the body of the request is the content of the file to be aggregated.
								It must be got by base64-decoding the value of the "internal" child field corresponding to each step of the iteration.
								For example, for the first step of the iteration, the "internal" child field is "myfolder/file1.txt", whose value "MTIz", once decoded, gives "123".
                                -->
    <iterate continueParent="true" expression="$ctx:BODY_FOR_RESOURCES//internal" id="SPLIT_AND_GATHER_INTERNAL_RESOURCES">
        <target>
            <sequence>
                <enrich>
                    <source clone="true" type="body"/>
                    <target property="ithIterationStep" type="property"/>
                </enrich>
                <property expression="$body/internal/resourceName" name="RESOURCE_NAME" scope="default" type="STRING"/>
                <script language="js"><![CDATA[//
                                    			var fileName = mc.getPayloadXML().resourceName;
                                    			var fileContent = mc.getPayloadXML().resourceBase64Content;
                                            	//var fileName = mc.getEnvelope().getBody().getChildElements().next().getLocalName();
                                            	mc.setProperty("fileName", fileName);
												//var fileContent = mc.getEnvelope().getBody().getFirstElement().getText();

							                    var decoded = new java.lang.String( org.apache.axiom.util.base64.Base64Utils.decode( fileContent));
							                    mc.setPayloadXML(
                                                    <ms11:text xmlns:ms11="http://ws.apache.org/commons/ns/payload">{decoded}</ms11:text>
							                    );
							        //]]></script>
                <!-- disable default http-transfer method for synapse (Transfer-Encoding: chunked) -->
                <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
                <property name="messageType" scope="axis2" type="STRING" value="text/plain"/>
                <!-- set http request header Content-Type: application/octet-stream -->
                <property name="ContentType" scope="axis2" type="STRING" value="application/octet-stream"/>
                <header name="Content-Type" scope="transport" value="application/octet-stream"/>
                <property name="Transfer-Encoding" scope="transport" type="STRING" value="base64"/>
                <!-- set http request header Slug to the filename got through the custom property filename set in the script directive above -->
                <property expression="get-property('fileName')" name="Slug" scope="transport" type="STRING"/>
                <!-- set the property uri.var.location to the url of the operation, to be used in the next "call" directive -->
                <property expression="get-property('LOCATION')" name="uri.var.location" scope="default" type="STRING"/>
                <!-- set http request header Authorization -->
                <property expression="get-property('AUTH')" name="Authorization" scope="transport" type="STRING"/>
                <!-- the other headers are set automatically: Content-Length, Host, Connection, User-Agent -->
                <!-- please note that two more http headers will be sent to the back-end:
                                                	Content-disposition: attachment; filename=".ro/manifest.rdf"
													Location: http://sandbox.rohub.org/rodl/ROs/cde-20/
													
												This is because they have not been deleted from the context and they are there from the first response from the back-end.
												Anyway, they are not dangerous, so no deletion is performed.
                                            -->
                <log level="custom">
                    <property name="mylog" value="***************************** CALLING BACK END: AGGREGATE INTERNAL RESOURCE **************************"/>
                </log>
                <call>
                    <endpoint name="aggregateInternalResources">
                        <http method="post" uri-template="{uri.var.location}">
                            <timeout>
                                <duration>240000</duration>
                                <responseAction>fault</responseAction>
                            </timeout>
                            <suspendOnFailure>
                                <errorCodes>-1</errorCodes>
                                <initialDuration>0</initialDuration>
                                <progressionFactor>1.0</progressionFactor>
                                <maximumDuration>0</maximumDuration>
                            </suspendOnFailure>
                            <markForSuspension>
                                <errorCodes>-1</errorCodes>
                            </markForSuspension>
                        </http>
                    </endpoint>
                </call>
                <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                    <then>
                        <log category="WARN" level="full">
                            <property expression="fn:concat('FAILED AGGREGATING INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                            <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                            <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                            <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                        </log>
                        <drop/>
                    </then>
                    <else>
                        <log>
                            <property expression="fn:concat('AGGREGATED INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                            <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                            <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                            <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                        </log>
                    </else>
                </filter>
                <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
                <property expression="$body//rdf:RDF/rdf:Description/ore:proxyFor/@rdf:resource" name="resourceUri" scope="default" type="STRING" xmlns:ore="http://www.openarchives.org/ore/terms/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"/>
                <property expression="$body//rdf:RDF/rdf:Description[rdf:type/@rdf:resource='http://www.openarchives.org/ore/terms/Proxy']/@rdf:about" name="proxyUri" scope="default" type="STRING" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"/>
                <enrich>
                    <source clone="true" property="ithIterationStep" type="property"/>
                    <target type="body"/>
                </enrich>
                <script function="transform" key="transform" language="js"/>
                <filter xpath=".[$body//forResource or $body//forProxy]">
                    <then>
                        <property action="remove" name="Location" scope="transport"/>
                        <property name="messageType" scope="axis2" type="STRING" value="application/rdf+xml"/>
                        <property name="Content-Type" scope="transport" type="STRING" value="application/rdf+xml"/>
                        <property action="remove" name="Link" scope="transport"/>
                        <!-- avoid setting the Slug parameter, thus letting RO API to choose annotation name -->
                        <property expression="get-property('AUTH')" name="Authorization" scope="transport" type="STRING"/>
                        <property expression="get-property('LOCATION')" name="uri.var.location" scope="default" type="STRING"/>
                        <iterate expression="$body//forResource/*" id="SPLIT_AND_GATHER_INTERNAL_RESOURCE_ANNOTATIONS">
                            <target>
                                <sequence>
                                    <property expression="$body" name="RDF_PROPERTY" scope="default" type="STRING"/>
                                    <property expression="fn:concat('&lt;', get-property('resourceUri'), '>; rel=&quot;http://purl.org/ao/annotatesResource&quot;')" name="Link" scope="transport" type="STRING"/>
                                    <script function="decoupleComplexAnnotation" key="decoupleComplexAnnotation" language="js"/>
                                    <call>
                                        <endpoint name="aggregateAnnotationsForInternalResources">
                                            <http method="post" uri-template="{uri.var.location}">
                                                <timeout>
                                                    <duration>240000</duration>
                                                    <responseAction>fault</responseAction>
                                                </timeout>
                                                <suspendOnFailure>
                                                    <errorCodes>-1</errorCodes>
                                                    <initialDuration>0</initialDuration>
                                                    <progressionFactor>1.0</progressionFactor>
                                                    <maximumDuration>0</maximumDuration>
                                                </suspendOnFailure>
                                                <markForSuspension>
                                                    <errorCodes>-1</errorCodes>
                                                </markForSuspension>
                                            </http>
                                        </endpoint>
                                    </call>
                                    <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                                        <then>
                                            <log category="WARN" level="full">
                                                <property expression="fn:concat('FAILED AGGREGATING ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                            <script language="js"><![CDATA[//
                                            	mc.setPayloadXML(<annotationForInternalResourceNotAggregated/>);
                                            //]]></script>
                                        </then>
                                        <else>
                                            <log>
                                                <property expression="fn:concat('AGGREGATED ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                        </else>
                                    </filter>
                                </sequence>
                            </target>
                        </iterate>
                        <aggregate id="SPLIT_AND_GATHER_INTERNAL_RESOURCE_ANNOTATIONS">
                            <completeCondition>
                                <messageCount max="-1" min="-1"/>
                            </completeCondition>
                            <onComplete expression="$body/*[1]">
                                <script language="js"><![CDATA[//
		                    	//curl -v -X POST -H "Authorization: Bearer ZXNiOmF5WjNTd2tuU1FiNg==" http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro=http://sandbox.rohub.org/rodl/ROs/test-RP2-snapshot/
		                    	//]]></script>
                                <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
                                <property name="Authorization" scope="transport" type="STRING" value="Bearer ZXNiOmF5WjNTd2tuU1FiNg=="/>
                                <property name="FORCE_POST_PUT_NOBODY" scope="axis2" type="BOOLEAN" value="true"/>
                                <script language="js"><![CDATA[//
	                            	mc.setPayloadXML(<nothing/>);
									mc.getEnvelope().getBody().getFirstElement().detach();
								//]]></script>
                                <call>
                                    <endpoint name="reindexAfterAggregatingAnnotationsForInternalResource">
                                        <http method="post" uri-template="http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro={uri.var.location}">
                                            <timeout>
                                                <duration>240000</duration>
                                                <responseAction>fault</responseAction>
                                            </timeout>
                                            <suspendOnFailure>
                                                <errorCodes>-1</errorCodes>
                                                <initialDuration>0</initialDuration>
                                                <progressionFactor>1.0</progressionFactor>
                                                <maximumDuration>0</maximumDuration>
                                            </suspendOnFailure>
                                            <markForSuspension>
                                                <errorCodes>-1</errorCodes>
                                            </markForSuspension>
                                        </http>
                                    </endpoint>
                                </call>
                                <drop/>
                            </onComplete>
                        </aggregate>
                        <iterate expression="$body//forProxy/*" id="SPLIT_AND_GATHER_INTERNAL_PROXY_ANNOTATIONS">
                            <target>
                                <sequence>
                                    <property expression="fn:concat('&lt;', get-property('proxyUri'), '>; rel=&quot;http://purl.org/ao/annotatesResource&quot;')" name="Link" scope="transport" type="STRING"/>
                                    <property expression="$body" name="RDF_PROPERTY" scope="default" type="STRING"/>
                                    <script function="decoupleComplexAnnotation" key="decoupleComplexAnnotation" language="js"/>
                                    <call>
                                        <endpoint name="aggregateAnnotationsForInternalResourceProxies">
                                            <http method="post" uri-template="{uri.var.location}">
                                                <timeout>
                                                    <duration>240000</duration>
                                                    <responseAction>fault</responseAction>
                                                </timeout>
                                                <suspendOnFailure>
                                                    <errorCodes>-1</errorCodes>
                                                    <initialDuration>0</initialDuration>
                                                    <progressionFactor>1.0</progressionFactor>
                                                    <maximumDuration>0</maximumDuration>
                                                </suspendOnFailure>
                                                <markForSuspension>
                                                    <errorCodes>-1</errorCodes>
                                                </markForSuspension>
                                            </http>
                                        </endpoint>
                                    </call>
                                    <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                                        <then>
                                            <log category="WARN" level="full">
                                                <property expression="fn:concat('FAILED AGGREGATING ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR PROXY ', get-property('proxyUri'), ' OF INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                            <script language="js"><![CDATA[//
                                            	mc.setPayloadXML(<annotationForInternalProxyNotAggregated/>);
                                            //]]></script>
                                        </then>
                                        <else>
                                            <log>
                                                <property expression="fn:concat('AGGREGATED ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR PROXY ', get-property('proxyUri'), ' OF INTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                        </else>
                                    </filter>
                                </sequence>
                            </target>
                        </iterate>
                        <aggregate id="SPLIT_AND_GATHER_INTERNAL_PROXY_ANNOTATIONS">
                            <completeCondition>
                                <messageCount max="-1" min="-1"/>
                            </completeCondition>
                            <onComplete expression="$body/*[1]">
                                <script language="js"><![CDATA[//
		                    	//curl -v -X POST -H "Authorization: Bearer ZXNiOmF5WjNTd2tuU1FiNg==" http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro=http://sandbox.rohub.org/rodl/ROs/test-RP2-snapshot/
		                    	//]]></script>
                                <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
                                <property name="Authorization" scope="transport" type="STRING" value="Bearer ZXNiOmF5WjNTd2tuU1FiNg=="/>
                                <property name="FORCE_POST_PUT_NOBODY" scope="axis2" type="BOOLEAN" value="true"/>
                                <script language="js"><![CDATA[//
	                            	mc.setPayloadXML(<nothing/>);
									mc.getEnvelope().getBody().getFirstElement().detach();
								//]]></script>
                                <call>
                                    <endpoint name="reindexAfterAggregatingAnnotationsForInternalProxy">
                                        <http method="post" uri-template="http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro={uri.var.location}">
                                            <timeout>
                                                <duration>240000</duration>
                                                <responseAction>fault</responseAction>
                                            </timeout>
                                            <suspendOnFailure>
                                                <errorCodes>-1</errorCodes>
                                                <initialDuration>0</initialDuration>
                                                <progressionFactor>1.0</progressionFactor>
                                                <maximumDuration>0</maximumDuration>
                                            </suspendOnFailure>
                                            <markForSuspension>
                                                <errorCodes>-1</errorCodes>
                                            </markForSuspension>
                                        </http>
                                    </endpoint>
                                </call>
                                <drop/>
                            </onComplete>
                        </aggregate>
                    </then>
                    <else/>
                </filter>
                <drop/>
            </sequence>
        </target>
        <!-- after this "iterate" directive due to xPath expression terminating in "*" the root-->
    </iterate>
    <log level="custom">
        <property name="mylog" value="***************************** ITERATING OVER EXTERNAL RESOURCES **************************"/>
    </log>
    <!--
	                    		do the next set of invocations to the back-end:
	                    			4. Optional aggregation of external resources
                                For all items in the "external" field in the body of the client request, invoke the aggregation operation of the back-end.
                                Given the example client request, external resources to be aggregated are 2, because 2 are the items in the "external" field : ["http://sdeg.com/resource1.html", "https://sdeg.it/res2.do"]
                                For the first invocation of the aggregation operation, the http request to be synthesized is (for the other invocation it is analogous, only the attribute rdf:resource in the xml body must be set accordingly):
                                	
									POST /rodl/ROs/cde-20/ HTTP/1.1
									Authorization: Bearer 7d6df5f8-6b5c-4d88-95e1-da101dcee6f8
									Content-Type: application/vnd.wf4ever.proxy
									Content-Length: 222
									Host: sandbox.rohub.org
									Connection: Keep-Alive
									User-Agent: Synapse-PT-HttpComponents-NIO
									
									<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:ore="http://www.openarchives.org/ore/terms/">
									  <ore:Proxy>
									    <ore:proxyFor rdf:resource="http://sdeg.com/resource1.html"/>
									  </ore:Proxy>
									</rdf:RDF>
									
								Please note that the value of the rdf:resource attribute in the xml body is given by the name of the "external" array item corresponding to each step of the iteration
								For example, for the first step of the iteration, the "external" array item is "http://sdeg.com/resource1.html".
 
                                -->
    <iterate continueParent="true" expression="$ctx:BODY_FOR_RESOURCES//external" id="SPLIT_AND_GATHER_EXTERNAL_RESOURCES">
        <target>
            <sequence>
                <enrich>
                    <source clone="true" type="body"/>
                    <target property="ithIterationStep" type="property"/>
                </enrich>
                <property expression="$body/external/resourceUri" name="RESOURCE_URI" scope="default" type="STRING"/>
                <script language="js"><![CDATA[//
                                    			var uri = mc.getPayloadXML().resourceUri;
												var proxy = <rdf:RDF xmlns:ore='http://www.openarchives.org/ore/terms/' xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'> <ore:Proxy> <ore:proxyFor rdf:resource={uri}/> </ore:Proxy> </rdf:RDF>;
							                    mc.setPayloadXML( proxy);]]></script>
                <!-- disable default http-transfer method for synapse (Transfer-Encoding: chunked) -->
                <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
                <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
                <!-- set http request header Content-Type: application/vnd.wf4ever.proxy -->
                <property name="ContentType" scope="axis2" type="STRING" value="application/vnd.wf4ever.proxy"/>
                <header name="Content-Type" scope="transport" value="application/vnd.wf4ever.proxy"/>
                <property expression="get-property('LOCATION')" name="uri.var.location" scope="default" type="STRING"/>
                <property expression="get-property('AUTH')" name="Authorization" scope="transport" type="STRING"/>
                <!-- the other headers are set automatically: Content-Length, Host, Connection, User-Agent -->
                <!-- please note that two more http headers will be sent to the back-end:
                                                	Content-disposition: attachment; filename=".ro/manifest.rdf"
													Location: http://sandbox.rohub.org/rodl/ROs/cde-20/
													
												This is because they have not been deleted from the context and they are there from the first response from the back-end.
												Anyway, they are not dangerous, so no deletion is performed.
                                            -->
                <log level="custom">
                    <property name="mylog" value="***************************** CALLING BACK END: AGGREGATE EXTERNAL RESOURCE **************************"/>
                </log>
                <call>
                    <endpoint name="aggregateExternal">
                        <http method="post" uri-template="{uri.var.location}">
                            <timeout>
                                <duration>240000</duration>
                                <responseAction>fault</responseAction>
                            </timeout>
                            <suspendOnFailure>
                                <errorCodes>-1</errorCodes>
                                <initialDuration>0</initialDuration>
                                <progressionFactor>1.0</progressionFactor>
                                <maximumDuration>0</maximumDuration>
                            </suspendOnFailure>
                            <markForSuspension>
                                <errorCodes>-1</errorCodes>
                            </markForSuspension>
                        </http>
                    </endpoint>
                </call>
                <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                    <then>
                        <log category="WARN" level="full">
                            <property expression="fn:concat('FAILED AGGREGATING EXTERNAL RESOURCE ', get-property('RESOURCE_URI'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                            <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                            <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                            <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                        </log>
                        <drop/>
                    </then>
                    <else>
                        <log>
                            <property expression="fn:concat('AGGREGATED EXTERNAL RESOURCE ', get-property('RESOURCE_URI'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                            <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                            <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                            <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                        </log>
                    </else>
                </filter>
                <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
                <property expression="$body//rdf:RDF/rdf:Description/ore:proxyFor/@rdf:resource" name="resourceUri" scope="default" type="STRING" xmlns:ore="http://www.openarchives.org/ore/terms/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"/>
                <property expression="$body//rdf:RDF/rdf:Description[rdf:type/@rdf:resource='http://www.openarchives.org/ore/terms/Proxy']/@rdf:about" name="proxyUri" scope="default" type="STRING" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"/>
                <enrich>
                    <source clone="true" property="ithIterationStep" type="property"/>
                    <target type="body"/>
                </enrich>
                <script function="transform" key="transform" language="js"/>
                <filter xpath=".[$body//forResource or $body//forProxy]">
                    <then>
                        <property action="remove" name="Location" scope="transport"/>
                        <property name="messageType" scope="axis2" type="STRING" value="application/rdf+xml"/>
                        <property name="Content-Type" scope="transport" type="STRING" value="application/rdf+xml"/>
                        <property action="remove" name="Link" scope="transport"/>
                        <!-- avoid setting the Slug parameter, thus letting RO API to choose annotation name -->
                        <property expression="get-property('AUTH')" name="Authorization" scope="transport" type="STRING"/>
                        <property expression="get-property('LOCATION')" name="uri.var.location" scope="default" type="STRING"/>
                        <iterate expression="$body//forResource/*" id="SPLIT_AND_GATHER_EXTERNAL_RESOURCE_ANNOTATIONS">
                            <target>
                                <sequence>
                                    <property expression="$body" name="RDF_PROPERTY" scope="default" type="STRING"/>
                                    <property expression="fn:concat('&lt;', get-property('resourceUri'), '>; rel=&quot;http://purl.org/ao/annotatesResource&quot;')" name="Link" scope="transport" type="STRING"/>
                                    <script function="decoupleComplexAnnotation" key="decoupleComplexAnnotation" language="js"/>
                                    <call>
                                        <endpoint name="aggregateAnnotationsForExternalResources">
                                            <http method="post" uri-template="{uri.var.location}">
                                                <timeout>
                                                    <duration>240000</duration>
                                                    <responseAction>fault</responseAction>
                                                </timeout>
                                                <suspendOnFailure>
                                                    <errorCodes>-1</errorCodes>
                                                    <initialDuration>0</initialDuration>
                                                    <progressionFactor>1.0</progressionFactor>
                                                    <maximumDuration>0</maximumDuration>
                                                </suspendOnFailure>
                                                <markForSuspension>
                                                    <errorCodes>-1</errorCodes>
                                                </markForSuspension>
                                            </http>
                                        </endpoint>
                                    </call>
                                    <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                                        <then>
                                            <log category="WARN" level="full">
                                                <property expression="fn:concat('FAILED AGGREGATING ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR EXTERNAL RESOURCE ', get-property('RESOURCE_URI'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                            <script language="js"><![CDATA[//
                                            	mc.setPayloadXML(<annotationForExternalProxyNotAggregated/>);
                                            //]]></script>
                                        </then>
                                        <else>
                                            <log>
                                                <property expression="fn:concat('AGGREGATED ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR EXTERNAL RESOURCE ', get-property('RESOURCE_URI'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                        </else>
                                    </filter>
                                </sequence>
                            </target>
                        </iterate>
                        <aggregate id="SPLIT_AND_GATHER_EXTERNAL_RESOURCE_ANNOTATIONS">
                            <completeCondition>
                                <messageCount max="-1" min="-1"/>
                            </completeCondition>
                            <onComplete expression="$body/*[1]">
                                <script language="js"><![CDATA[//
		                    	//curl -v -X POST -H "Authorization: Bearer ZXNiOmF5WjNTd2tuU1FiNg==" http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro=http://sandbox.rohub.org/rodl/ROs/test-RP2-snapshot/
		                    	//]]></script>
                                <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
                                <property name="Authorization" scope="transport" type="STRING" value="Bearer ZXNiOmF5WjNTd2tuU1FiNg=="/>
                                <property name="FORCE_POST_PUT_NOBODY" scope="axis2" type="BOOLEAN" value="true"/>
                                <script language="js"><![CDATA[//
	                            	mc.setPayloadXML(<nothing/>);
									mc.getEnvelope().getBody().getFirstElement().detach();
								//]]></script>
                                <call>
                                    <endpoint name="reindexAfterAggregatingAnnotationsForExternalResource">
                                        <http method="post" uri-template="http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro={uri.var.location}">
                                            <timeout>
                                                <duration>240000</duration>
                                                <responseAction>fault</responseAction>
                                            </timeout>
                                            <suspendOnFailure>
                                                <errorCodes>-1</errorCodes>
                                                <initialDuration>0</initialDuration>
                                                <progressionFactor>1.0</progressionFactor>
                                                <maximumDuration>0</maximumDuration>
                                            </suspendOnFailure>
                                            <markForSuspension>
                                                <errorCodes>-1</errorCodes>
                                            </markForSuspension>
                                        </http>
                                    </endpoint>
                                </call>
                                <drop/>
                            </onComplete>
                        </aggregate>
                        <iterate expression="$body//forProxy/*" id="SPLIT_AND_GATHER_EXTERNAL_PROXY_ANNOTATIONS">
                            <target>
                                <sequence>
                                    <property expression="$body" name="RDF_PROPERTY" scope="default" type="STRING"/>
                                    <property expression="fn:concat('&lt;', get-property('proxyUri'), '>; rel=&quot;http://purl.org/ao/annotatesResource&quot;')" name="Link" scope="transport" type="STRING"/>
                                    <script function="decoupleComplexAnnotation" key="decoupleComplexAnnotation" language="js"/>
                                    <call>
                                        <endpoint name="aggregateAnnotationsForExternalResourceProxies">
                                            <http method="post" uri-template="{uri.var.location}">
                                                <timeout>
                                                    <duration>240000</duration>
                                                    <responseAction>fault</responseAction>
                                                </timeout>
                                                <suspendOnFailure>
                                                    <errorCodes>-1</errorCodes>
                                                    <initialDuration>0</initialDuration>
                                                    <progressionFactor>1.0</progressionFactor>
                                                    <maximumDuration>0</maximumDuration>
                                                </suspendOnFailure>
                                                <markForSuspension>
                                                    <errorCodes>-1</errorCodes>
                                                </markForSuspension>
                                            </http>
                                        </endpoint>
                                    </call>
                                    <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
                                        <then>
                                            <log category="WARN" level="full">
                                                <property expression="fn:concat('FAILED AGGREGATING ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR PROXY ', get-property('proxyUri'), ' OF EXTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                            <script language="js"><![CDATA[//
                                            	mc.setPayloadXML(<annotationForExternalProxyNotAggregated/>);
                                            //]]></script>
                                        </then>
                                        <else>
                                            <log>
                                                <property expression="fn:concat('AGGREGATED ANNOTATION WITH BODY ', get-property('RDF_PROPERTY'), ' FOR PROXY ', get-property('proxyUri'), ' OF EXTERNAL RESOURCE ', get-property('RESOURCE_NAME'), ' IN THE RO ', get-property('uri.var.location'))" name="APPL"/>
                                                <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                                                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                                                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
                                            </log>
                                        </else>
                                    </filter>
                                </sequence>
                            </target>
                        </iterate>
                        <aggregate id="SPLIT_AND_GATHER_EXTERNAL_PROXY_ANNOTATIONS">
                            <completeCondition>
                                <messageCount max="-1" min="-1"/>
                            </completeCondition>
                            <onComplete expression="$body/*[1]">
                                <script language="js"><![CDATA[//
		                    	//curl -v -X POST -H "Authorization: Bearer ZXNiOmF5WjNTd2tuU1FiNg==" http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro=http://sandbox.rohub.org/rodl/ROs/test-RP2-snapshot/
		                    	//]]></script>
                                <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
                                <property name="Authorization" scope="transport" type="STRING" value="Bearer ZXNiOmF5WjNTd2tuU1FiNg=="/>
                                <property name="FORCE_POST_PUT_NOBODY" scope="axis2" type="BOOLEAN" value="true"/>
                                <script language="js"><![CDATA[//
	                            	mc.setPayloadXML(<nothing/>);
									mc.getEnvelope().getBody().getFirstElement().detach();
								//]]></script>
                                <call>
                                    <endpoint name="reindexAfterAggregatingAnnotationsForExternalProxy">
                                        <http method="post" uri-template="http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro={uri.var.location}">
                                            <timeout>
                                                <duration>240000</duration>
                                                <responseAction>fault</responseAction>
                                            </timeout>
                                            <suspendOnFailure>
                                                <errorCodes>-1</errorCodes>
                                                <initialDuration>0</initialDuration>
                                                <progressionFactor>1.0</progressionFactor>
                                                <maximumDuration>0</maximumDuration>
                                            </suspendOnFailure>
                                            <markForSuspension>
                                                <errorCodes>-1</errorCodes>
                                            </markForSuspension>
                                        </http>
                                    </endpoint>
                                </call>
                                <drop/>
                            </onComplete>
                        </aggregate>
                    </then>
                    <else/>
                </filter>
                <drop/>
            </sequence>
        </target>
    </iterate>
    <!--
	                                do the next set of invocations to the back-end:
                    					5. Annotate the RO with the title, description, and VRC

                                
	                                Authorization: Bearer 7d6df5f8-6b5c-4d88-95e1-da101dcee6f8
									Slug: title.rdf
									Link: <http://sandbox.rohub.org/rodl/ROs/cde-20/>; rel="http://purl.org/ao/annotatesResource"
									Content-Type: application/xml
									Transfer-Encoding: chunked
									Host: sandbox.rohub.org
									Connection: Keep-Alive
									User-Agent: Synapse-PT-HttpComponents-NIO
									
									4c9
									<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:pavauth="http://purl.org/pav/authoring/2.0/" xmlns:ore="http://www.openarchives.org/ore/terms/" xmlns:wf4ever="http://purl.org/wf4ever/wf4ever#" xmlns:pav="http://purl.org/pav/2.0/" xmlns:roterms="http://purl.org/wf4ever/roterms#" xmlns:skos="http://www.w3.org/TR/skos-reference/skos-owl1-dl.rdf" xmlns:ao="http://purl.org/ao/" xmlns:acs="http://www.acsys.it/everest#" xmlns:dct="http://purl.org/dc/terms/" xmlns:ore-owl="http://purl.org/wf4ever/ore-owl" xmlns:wfprov="http://purl.org/wf4ever/wfprov#" xmlns:roevo="http://purl.org/wf4ever/roevo#" xmlns:aocore="http://purl.org/ao/core/" xmlns:pavprov="http://purl.org/pav/provenance/2.0/" xmlns:prov="http://www.w3.org/ns/prov#" xmlns:ro="http://purl.org/wf4ever/ro#" xmlns:wfdesc="http://purl.org/wf4ever/wfdesc#" xmlns:foaf="http://xmlns.com/foaf/0.1/">
									  <rdf:Description rdf:about="">
									    <dct:title rdf:datatype="http://www.w3.org/2001/XMLSchema#string">The Title</dct:title>
									    <dct:description rdf:datatype="http://www.w3.org/2001/XMLSchema#string">The Description</dct:description>
									    <acs:vrc rdf:datatype="http://www.w3.org/2001/XMLSchema#string">CNR</acs:vrc>
									  </rdf:Description>
									</rdf:RDF>
									0
								
								Please note that the Slug header has been set to "title.rdf" and this value is embedded in the next block of directive. Its value is not important, it can be whatever.                                
                                -->
    <!-- 
                                    create the rdf xml for the title, the description and the VRC that will be aggregated to the RO as an annotation
                                	from the former request body, values of ro_title, ro_desc and ro_vrc fields are read into an rdf xml template
                                 -->
    <!-- (WSO2ESB) Note that I can still read the PayloadJSON from the mc even though with the previous access to the mc I deleted the payloadXML-->
    <script language="js"><![CDATA[var ro_title = mc.getPayloadJSON().ro_title.toString();
				                    var ro_desc = mc.getPayloadJSON().ro_desc.toString();
				                    var ro_vrc = mc.getPayloadJSON().ro_vrc.toString();
				                    var ro_name = mc.getProperty('RONAME');
				                    mc.setPayloadXML(
				                    	<rdf:RDF xmlns:acs="http://www.acsys.it/everest#" xmlns:roevo='http://purl.org/wf4ever/roevo#' xmlns:pavprov='http://purl.org/pav/provenance/2.0/' xmlns:ore-owl='http://purl.org/wf4ever/ore-owl' xmlns:ao='http://purl.org/ao/' xmlns:skos='http://www.w3.org/TR/skos-reference/skos-owl1-dl.rdf' xmlns:prov='http://www.w3.org/ns/prov#' xmlns:wfdesc='http://purl.org/wf4ever/wfdesc#' xmlns:pav='http://purl.org/pav/2.0/' xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#' xmlns:ro='http://purl.org/wf4ever/ro#' xmlns:roterms='http://purl.org/wf4ever/roterms#' xmlns:foaf='http://xmlns.com/foaf/0.1/' xmlns:wfprov='http://purl.org/wf4ever/wfprov#' xmlns:dct='http://purl.org/dc/terms/' xmlns:ore='http://www.openarchives.org/ore/terms/' xmlns:pavauth='http://purl.org/pav/authoring/2.0/' xmlns:wf4ever='http://purl.org/wf4ever/wf4ever#' xmlns:aocore='http://purl.org/ao/core/' > <rdf:Description rdf:about=''> <dct:title rdf:datatype='http://www.w3.org/2001/XMLSchema#string'>{ro_title}</dct:title> <dct:description rdf:datatype='http://www.w3.org/2001/XMLSchema#string'>{ro_desc}</dct:description> <acs:vrc rdf:datatype='http://www.w3.org/2001/XMLSchema#string'>{ro_vrc}</acs:vrc>  </rdf:Description> </rdf:RDF>
				                    );]]></script>
    <log level="custom">
        <property name="mylog" value="***************************** ANNOTATION RDFXML rendered **************************"/>
    </log>
    <!-- remove Location header coming from previous response -->
    <property action="remove" name="Location" scope="transport"/>
    <!-- choose the xml formatter -->
    <property name="messageType" scope="axis2" type="STRING" value="application/xml"/>
    <!-- set headers -->
    <property name="Content-Type" scope="transport" type="STRING" value="application/rdf+xml"/>
    <property name="Slug" scope="transport" type="STRING" value="title.rdf"/>
    <property expression="get-property('AUTH')" name="Authorization" scope="transport" type="STRING"/>
    <property expression="fn:concat('&lt;', get-property('RONAME'), '>; rel=&quot;http://purl.org/ao/annotatesResource&quot;')" name="Link" scope="transport" type="STRING"/>
    <!-- the other headers are set automatically: Transfer-Encoding, Host, Connection, User-Agent -->
    <!-- please note that one more http header will be sent to the back-end:
                                               	Content-disposition: attachment; filename=".ro/manifest.rdf"
												
									This is because it has not been deleted from the context and it is there from the first response from the back-end.
									Anyway, it is not dangerous, so no deletion is performed.
                                -->
    <log level="custom">
        <property name="mylog" value="*********************** CALLING BACK END: AGGREGATE ANNOTATIONS ********************"/>
        <property expression="get-property('transport', 'Link')" name="TheLink"/>
    </log>
    <!-- call the annotation operation on the ro api -->
    <property expression="get-property('LOCATION')" name="uri.var.location" scope="default" type="STRING"/>
    <call>
        <endpoint name="setTitleAndDescription">
            <http method="post" uri-template="{uri.var.location}">
                <timeout>
                    <duration>240000</duration>
                    <responseAction>fault</responseAction>
                </timeout>
                <suspendOnFailure>
                    <errorCodes>-1</errorCodes>
                    <initialDuration>0</initialDuration>
                    <progressionFactor>1.0</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <errorCodes>-1</errorCodes>
                </markForSuspension>
            </http>
        </endpoint>
    </call>
    <filter regex="^[45][0-9][0-9]" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <log category="WARN" level="full">
                <property expression="fn:concat('FAILED SETTING TITLE AND DESCRIPTION OF THE RO ', get-property('uri.var.location'))" name="APPL"/>
                <property name="STEP" value="SUBOPERATION ENDED EXCEPTIONALLY"/>
                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
            </log>
            <script language="js"><![CDATA[//
		                    	//curl -v -X POST -H "Authorization: Bearer ZXNiOmF5WjNTd2tuU1FiNg==" http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro=http://sandbox.rohub.org/rodl/ROs/test-RP2-snapshot/
		                    	//]]></script>
            <property action="remove" name="TRANSPORT_HEADERS" scope="axis2"/>
            <property name="Authorization" scope="transport" type="STRING" value="Bearer ZXNiOmF5WjNTd2tuU1FiNg=="/>
            <property name="FORCE_POST_PUT_NOBODY" scope="axis2" type="BOOLEAN" value="true"/>
            <script language="js"><![CDATA[//
	                            	mc.setPayloadXML(<nothing/>);
									mc.getEnvelope().getBody().getFirstElement().detach();
								//]]></script>
            <call>
                <endpoint name="reindexAfterSettingTitleAndDescription">
                    <http method="post" uri-template="http://sandbox.rohub.org/rodl/service/solr/reindex-ro/?ro={uri.var.location}">
                        <timeout>
                            <duration>240000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <errorCodes>-1</errorCodes>
                            <initialDuration>0</initialDuration>
                            <progressionFactor>1.0</progressionFactor>
                            <maximumDuration>0</maximumDuration>
                        </suspendOnFailure>
                        <markForSuspension>
                            <errorCodes>-1</errorCodes>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
        </then>
        <else>
            <log>
                <property expression="fn:concat('SET TITLE AND DESCRIPTION OF THE RO ', get-property('uri.var.location'))" name="APPL"/>
                <property name="STEP" value="SUBOPERATION ENDED ORDINARILY"/>
                <property expression="get-property('REQUEST_ID')" name="REQUEST_ID"/>
                <property expression="get-property('axis2', 'HTTP_SC')" name="HTTP_SC"/>
            </log>
        </else>
    </filter>
</sequence>
